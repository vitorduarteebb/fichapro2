{% extends 'base.html' %}
{% load static widget_tweaks %}

{% block title %}Cadastro de Ficha Técnica{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Cadastro de Ficha Técnica para {{ restaurante.nome_restaurante }}</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <!-- Dados da Ficha Técnica -->
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        Dados da Ficha Técnica
      </div>
      <div class="card-body">
        {{ form.as_p }}
      </div>
    </div>
    
    <!-- Insumos Utilizados -->
    <div class="card mb-3">
      <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span>Insumos Utilizados</span>
        <button type="button" class="btn btn-light btn-sm" id="addInsumo" title="Adicionar Insumo">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="card-body">
        {{ formset_insumos.management_form }}
        <div id="formset-container-insumos">
          {% for form in formset_insumos %}
          <div class="row mb-2 formset-item">
            <div class="col-md-3">
              {{ form.insumo.label_tag }}
              {{ form.insumo|add_class:"form-control insumo-select" }}
            </div>
            <div class="col-md-2">
              {{ form.quantidade_utilizada.label_tag }}
              {{ form.quantidade_utilizada|add_class:"form-control quantidade-input" }}
            </div>
            <div class="col-md-2">
              {{ form.unidade.label_tag }}
              {{ form.unidade|add_class:"form-control unidade-select" }}
            </div>
            <div class="col-md-3">
              <label>Custo (R$)</label>
              <input type="text" class="form-control custo-utilizada" readonly>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-danger btn-sm remove-item" title="Remover Insumo">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
        <!-- Template vazio para insumos -->
        <script type="text/template" id="empty-form-template-insumos">
          <div class="row mb-2 formset-item">
            <div class="col-md-3">
              {{ formset_insumos.empty_form.insumo.label_tag }}
              {{ formset_insumos.empty_form.insumo|add_class:"form-control insumo-select" }}
            </div>
            <div class="col-md-2">
              {{ formset_insumos.empty_form.quantidade_utilizada.label_tag }}
              {{ formset_insumos.empty_form.quantidade_utilizada|add_class:"form-control quantidade-input" }}
            </div>
            <div class="col-md-2">
              {{ formset_insumos.empty_form.unidade.label_tag }}
              {{ formset_insumos.empty_form.unidade|add_class:"form-control unidade-select" }}
            </div>
            <div class="col-md-3">
              <label>Custo (R$)</label>
              <input type="text" class="form-control custo-utilizada" readonly>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-danger btn-sm remove-item" title="Remover Insumo">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </script>
      </div>
    </div>
    
    <!-- Receitas Selecionadas -->
    <div class="card mb-3">
      <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span>Receitas Selecionadas</span>
        <button type="button" class="btn btn-light btn-sm" id="addReceita" title="Adicionar Receita">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="card-body">
        {{ formset_receitas.management_form }}
        <div id="formset-container-receitas">
          {% for form in formset_receitas %}
          <div class="row mb-2 formset-item">
            <div class="col-md-4">
              {{ form.receita.label_tag }}
              {{ form.receita|add_class:"form-control receita-select" }}
            </div>
            <div class="col-md-3">
              {{ form.quantidade_utilizada.label_tag }}
              {{ form.quantidade_utilizada|add_class:"form-control quantidade-input" }}
            </div>
            <div class="col-md-2">
              {{ form.unidade.label_tag }}
              {{ form.unidade|add_class:"form-control" }}
            </div>
            <div class="col-md-2">
              <label>Custo (R$)</label>
              <input type="text" class="form-control custo-utilizada" readonly>
            </div>
            <div class="col-md-1">
              <button type="button" class="btn btn-danger btn-sm remove-item" title="Remover Receita">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
        <!-- Template vazio para receitas -->
        <script type="text/template" id="empty-form-template-receitas">
          <div class="row mb-2 formset-item">
            <div class="col-md-4">
              {{ formset_receitas.empty_form.receita.label_tag }}
              {{ formset_receitas.empty_form.receita|add_class:"form-control receita-select" }}
            </div>
            <div class="col-md-3">
              {{ formset_receitas.empty_form.quantidade_utilizada.label_tag }}
              {{ formset_receitas.empty_form.quantidade_utilizada|add_class:"form-control quantidade-input" }}
            </div>
            <div class="col-md-2">
              {{ formset_receitas.empty_form.unidade.label_tag }}
              {{ formset_receitas.empty_form.unidade|add_class:"form-control" }}
            </div>
            <div class="col-md-2">
              <label>Custo (R$)</label>
              <input type="text" class="form-control custo-utilizada" readonly>
            </div>
            <div class="col-md-1">
              <button type="button" class="btn btn-danger btn-sm remove-item" title="Remover Receita">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </script>
      </div>
    </div>
    
    <!-- Totais da Ficha Técnica -->
    <div class="card mb-3">
      <div class="card-header bg-dark text-white">
        Totais da Ficha Técnica
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <label>Peso Total (g):</label>
            <input type="text" id="pesoTotal" class="form-control" readonly>
          </div>
          <div class="col-md-4">
            <label>Custo Total (R$):</label>
            <input type="text" id="custoTotal" class="form-control" readonly>
          </div>
          <div class="col-md-4">
            <label>Valor de Venda Sugerida (R$):</label>
            <input type="text" id="valorVendaSugerida" class="form-control" readonly>
          </div>
        </div>
      </div>
    </div>
    
    <button type="submit" class="btn btn-success">Cadastrar Ficha Técnica</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  console.log("DOM fully loaded for Ficha Técnica.");
  var insumosData = {{ insumos_json|default:"[]"|safe }};
  var receitasData = {{ receitas_json|default:"[]"|safe }};
  console.log("Insumos Data:", insumosData);
  console.log("Receitas Data:", receitasData);
  
  // Função para buscar dados de insumo por id
  function getInsumoDataById(id) {
    for (var i = 0; i < insumosData.length; i++) {
      if (parseInt(insumosData[i].id) === parseInt(id)) {
        return insumosData[i];
      }
    }
    console.log("Insumo not found for id:", id);
    return null;
  }
  
  // Função para buscar dados de receita por id
  function getReceitaDataById(id) {
    for (var i = 0; i < receitasData.length; i++) {
      if (parseInt(receitasData[i].id) === parseInt(id)) {
        return receitasData[i];
      }
    }
    console.log("Receita not found for id:", id);
    return null;
  }
  
  function convertQuantity(value, fromUnit, toUnit) {
    if (fromUnit === toUnit) return value;
    if (fromUnit === 'kg' && toUnit === 'g') return value * 1000;
    if (fromUnit === 'g' && toUnit === 'kg') return value / 1000;
    return value;
  }
  
  function updateCostInsumo(formItem) {
    var insumoSelect = formItem.querySelector('.insumo-select');
    var quantidadeInput = formItem.querySelector('.quantidade-input');
    var unidadeSelect = formItem.querySelector('.unidade-select');
    var custoInput = formItem.querySelector('.custo-utilizada');
    if (!insumoSelect || !quantidadeInput || !unidadeSelect || !custoInput) return;
    var insumoId = insumoSelect.value;
    var quantidade = parseFloat(quantidadeInput.value) || 0;
    var unidadeSelecionada = unidadeSelect.value.toLowerCase();
    var insumoData = getInsumoDataById(insumoId);
    if (insumoData) {
      var insumoPrice = parseFloat(insumoData.preco);
      var cost = 0;
      var base_unit = insumoData.unidade ? insumoData.unidade.toLowerCase() : "";
      // Se o insumo foi cadastrado em 'g'
      if (base_unit === 'g' && insumoData.peso) {
        var pesoBase = parseFloat(insumoData.peso);
        // Converte a quantidade se o usuário selecionou 'kg'
        var quantidade_convertida = (unidadeSelecionada === 'kg') ? (quantidade * 1000) : quantidade;
        cost = (quantidade_convertida / pesoBase) * insumoPrice;
        console.log("Calculating cost (g): quantidade (converted) =", quantidade_convertida, "pesoBase =", pesoBase, "insumoPrice =", insumoPrice);
      } else {
        cost = quantidade * insumoPrice;
        console.log("Calculating cost (direct): quantidade =", quantidade, "insumoPrice =", insumoPrice);
      }
      custoInput.value = cost.toFixed(2);
      console.log("Insumo cost updated:", cost.toFixed(2));
    } else {
      custoInput.value = "";
    }
  }
  
  function updateCostReceita(formItem) {
    var receitaSelect = formItem.querySelector('.receita-select');
    var quantidadeInput = formItem.querySelector('.quantidade-input');
    var unidadeSelect = formItem.querySelector('select[name$="-unidade"]');
    var custoInput = formItem.querySelector('.custo-utilizada');
    if (!receitaSelect || !quantidadeInput || !unidadeSelect || !custoInput) return;
    var receitaId = receitaSelect.value;
    var quantidade = parseFloat(quantidadeInput.value) || 0;
    var selectedUnit = unidadeSelect.value.toLowerCase();
    var receitaData = getReceitaDataById(receitaId);
    if (receitaData) {
      var precoKG = parseFloat(receitaData.preco_kg);
      if (isNaN(precoKG)) {
        precoKG = 0;
      }
      // Converter quantidade para kg se necessário
      var qt_kg = (selectedUnit === 'g') ? (quantidade / 1000) : quantidade;
      var cost = qt_kg * precoKG;
      custoInput.value = cost.toFixed(2);
      console.log("Receita cost updated:", cost.toFixed(2));
    } else {
      custoInput.value = "";
    }
  }
  
  function updateTotals() {
    var totalWeight = 0;
    var totalCostInsumos = 0;
    var totalCostReceitas = 0;
    
    // Atualiza insumos
    Array.prototype.forEach.call(document.querySelectorAll('#formset-container-insumos .formset-item'), function(item) {
      var quantidadeInput = item.querySelector('.quantidade-input');
      var insumoSelect = item.querySelector('.insumo-select');
      var unidadeSelect = item.querySelector('.unidade-select');
      var custoInput = item.querySelector('.custo-utilizada');
      if (!quantidadeInput || !insumoSelect || !unidadeSelect || !custoInput) return;
      var quantidade = parseFloat(quantidadeInput.value) || 0;
      var unidadeSelecionada = unidadeSelect.value.toLowerCase();
      var insumoData = getInsumoDataById(insumoSelect.value);
      if (insumoData) {
        var base_unit = insumoData.unidade ? insumoData.unidade.toLowerCase() : "";
        // Converter a quantidade para a unidade base
        var converted = convertQuantity(quantidade, unidadeSelecionada, base_unit);
        // Se a unidade base for 'kg', converte para gramas para somar o peso total
        if (base_unit === 'kg') {
          totalWeight += converted * 1000;
        } else {
          totalWeight += converted;
        }
        totalCostInsumos += parseFloat(custoInput.value) || 0;
      }
    });
    
    // Atualiza receitas (soma também o peso dos itens)
    Array.prototype.forEach.call(document.querySelectorAll('#formset-container-receitas .formset-item'), function(item) {
      var quantidadeInput = item.querySelector('.quantidade-input');
      var receitaSelect = item.querySelector('.receita-select');
      var unidadeSelect = item.querySelector('select[name$="-unidade"]');
      var custoInput = item.querySelector('.custo-utilizada');
      if (!quantidadeInput || !receitaSelect || !unidadeSelect || !custoInput) return;
      var quantidade = parseFloat(quantidadeInput.value) || 0;
      var selectedUnit = unidadeSelect.value.toLowerCase();
      var receitaData = getReceitaDataById(receitaSelect.value);
      if (receitaData) {
        // Para o custo, converte para kg se necessário
        var qt_kg = (selectedUnit === 'g') ? (quantidade / 1000) : quantidade;
        totalCostReceitas += (qt_kg * parseFloat(receitaData.preco_kg)) || 0;
        // Para o peso, assume que a quantidade inserida é o peso (converte para gramas se for kg)
        var weight_receita = (selectedUnit === 'g') ? quantidade : quantidade * 1000;
        totalWeight += weight_receita;
      }
    });
    
    document.getElementById("pesoTotal").value = totalWeight.toFixed(2);
    document.getElementById("custoTotal").value = (totalCostInsumos + totalCostReceitas).toFixed(2);
    
    // Corrigindo a leitura do fator de correção: envolvendo-o em aspas
    var fatorCorr = parseFloat("{{ restaurante.fator_correcao_financeiro|default:'1.00' }}");
    var valorVenda = (totalCostInsumos + totalCostReceitas) * fatorCorr;
    document.getElementById("valorVendaSugerida").value = valorVenda.toFixed(2);
    
    var porcaoInput = document.querySelector("input[name='porcao_sugerida']");
    var porcao = porcaoInput ? (parseFloat(porcaoInput.value) || 0) : 0;
    var rendimentoInput = document.getElementById("rendimento");
    if (porcao > 0) {
      var rendimento = totalWeight / porcao;
      rendimentoInput.value = rendimento.toFixed(1);
    } else {
      rendimentoInput.value = "";
    }
    console.log("Totals updated: Weight =", totalWeight.toFixed(2), "Cost Insumos =", totalCostInsumos.toFixed(2), "Cost Receitas =", totalCostReceitas.toFixed(2));
  }
  
  function bindEvents(item, type) {
    if (type === "insumo") {
      var insumoSelect = item.querySelector('.insumo-select');
      var quantidadeInput = item.querySelector('.quantidade-input');
      var unidadeSelect = item.querySelector('.unidade-select');
      if (insumoSelect && quantidadeInput && unidadeSelect) {
        insumoSelect.addEventListener('change', function() {
          updateCostInsumo(item);
          updateTotals();
        });
        quantidadeInput.addEventListener('keyup', function() {
          updateCostInsumo(item);
          updateTotals();
        });
        unidadeSelect.addEventListener('change', function() {
          updateCostInsumo(item);
          updateTotals();
        });
      }
    } else if (type === "receita") {
      var receitaSelect = item.querySelector('.receita-select');
      var quantidadeInput = item.querySelector('.quantidade-input');
      var unidadeSelect = item.querySelector('select[name$="-unidade"]');
      if (receitaSelect && quantidadeInput && unidadeSelect) {
        receitaSelect.addEventListener('change', function() {
          updateCostReceita(item);
          updateTotals();
        });
        quantidadeInput.addEventListener('keyup', function() {
          updateCostReceita(item);
          updateTotals();
        });
        unidadeSelect.addEventListener('change', function() {
          updateCostReceita(item);
          updateTotals();
        });
      }
    }
  }
  
  // Bind events para os formsets iniciais
  Array.prototype.forEach.call(document.querySelectorAll('#formset-container-insumos .formset-item'), function(item) {
    bindEvents(item, "insumo");
  });
  Array.prototype.forEach.call(document.querySelectorAll('#formset-container-receitas .formset-item'), function(item) {
    bindEvents(item, "receita");
  });
  
  var addInsumoButton = document.getElementById("addInsumo");
  var formsetContainerInsumos = document.getElementById("formset-container-insumos");
  var totalFormsInsumos = document.querySelector('input[name^="insumos-TOTAL_FORMS"]');
  
  addInsumoButton.addEventListener("click", function(e) {
    e.preventDefault();
    if (!totalFormsInsumos) return;
    var currentCount = parseInt(totalFormsInsumos.value);
    var template = document.getElementById("empty-form-template-insumos").innerHTML;
    var newFormHtml = template.replace(/__prefix__/g, currentCount);
    var newContainer = document.createElement("div");
    newContainer.innerHTML = newFormHtml;
    var newItem = newContainer.firstElementChild;
    formsetContainerInsumos.appendChild(newItem);
    totalFormsInsumos.value = currentCount + 1;
    bindEvents(newItem, "insumo");
    updateTotals();
  });
  
  var addReceitaButton = document.getElementById("addReceita");
  var formsetContainerReceitas = document.getElementById("formset-container-receitas");
  var totalFormsReceitas = document.querySelector('input[name^="receitas-TOTAL_FORMS"]');
  
  addReceitaButton.addEventListener("click", function(e) {
    e.preventDefault();
    if (!totalFormsReceitas) return;
    var currentCount = parseInt(totalFormsReceitas.value);
    var template = document.getElementById("empty-form-template-receitas").innerHTML;
    var newFormHtml = template.replace(/__prefix__/g, currentCount);
    var newContainer = document.createElement("div");
    newContainer.innerHTML = newFormHtml;
    var newItem = newContainer.firstElementChild;
    formsetContainerReceitas.appendChild(newItem);
    totalFormsReceitas.value = currentCount + 1;
    bindEvents(newItem, "receita");
    updateTotals();
  });
  
  // Remoção de itens
  document.addEventListener("click", function(e) {
    var removeBtn = e.target.closest(".remove-item");
    if (removeBtn) {
      e.preventDefault();
      var item = removeBtn.closest(".formset-item");
      var container = item.parentNode;
      if (container.querySelectorAll(".formset-item").length > 1) {
        item.remove();
        if (container.id === "formset-container-insumos") {
          totalFormsInsumos.value = container.querySelectorAll(".formset-item").length;
        } else if (container.id === "formset-container-receitas") {
          totalFormsReceitas.value = container.querySelectorAll(".formset-item").length;
        }
        updateTotals();
      } else {
        alert("Pelo menos um item é obrigatório.");
      }
    }
  });
});
</script>
{% endblock %}

